<?xml version="1.0" encoding="UTF-8" ?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
        http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd">
    
    <changeSet id="6d98840c-9b24-4f11-add6-e67bf7d52287" author="Orion">
        <createTable tableName="bank">
            <column name="bic" type="text">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="designation" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createTable tableName="holder">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>
        <sql>
            CREATE TABLE "account"(
                "bank" TEXT NOT NULL REFERENCES "bank"("bic") ON UPDATE CASCADE ON DELETE RESTRICT,
                "country_code" TEXT NOT NULL,
                "check_digits" TEXT NOT NULL,
                "bban" TEXT NOT NULL,
                "domiciliation" TEXT NOT NULL,
                PRIMARY KEY (
                    "country_code",
                    "check_digits",
                    "bban"
                )
            );
        </sql>
        <sql>
            CREATE TABLE "single_account_holder"(
                "account_country_code" TEXT NOT NULL,
                "account_check_digits" TEXT NOT NULL,
                "account_bban" TEXT NOT NULL,
                "holder" UUID NOT NULL REFERENCES "holder"("id") ON UPDATE CASCADE ON DELETE CASCADE,
                PRIMARY KEY (
                    "account_country_code",
                    "account_check_digits",
                    "account_bban"
                ),
                FOREIGN KEY ("account_country_code", "account_check_digits", "account_bban")
                    REFERENCES "account"("country_code", "check_digits", "bban")
                    ON UPDATE CASCADE ON DELETE RESTRICT
            );
        </sql>
        <sql>
            CREATE TABLE "multiple_account_holder"(
                "account_country_code" TEXT NOT NULL,
                "account_check_digits" TEXT NOT NULL,
                "account_bban" TEXT NOT NULL,
                "combination" TEXT NOT NULL,
                PRIMARY KEY (
                    "account_country_code",
                    "account_check_digits",
                    "account_bban"
                ),
                FOREIGN KEY ("account_country_code", "account_check_digits", "account_bban")
                REFERENCES "account"("country_code", "check_digits", "bban")
                ON UPDATE CASCADE ON DELETE RESTRICT
            );
        </sql>
        <sql>
            CREATE TABLE "individual_holder_for_multiple_account_holder"(
                "account_country_code" TEXT NOT NULL,
                "account_check_digits" TEXT NOT NULL,
                "account_bban" TEXT NOT NULL,
                "holder" UUID NOT NULL REFERENCES "holder"("id") ON UPDATE CASCADE ON DELETE CASCADE,
                PRIMARY KEY (
                    "account_country_code",
                    "account_check_digits",
                    "account_bban",
                    "holder"
                ),
                FOREIGN KEY ("account_country_code", "account_check_digits", "account_bban")
                REFERENCES "account"("country_code", "check_digits", "bban")
                ON UPDATE CASCADE ON DELETE RESTRICT
            );
        </sql>
        <createTable tableName="card_type">
            <column name="name" type="text">
                <constraints primaryKey="true" nullable="false" />
            </column>
        </createTable>
        <sql>
            CREATE TABLE "card"(
                "number" TEXT NOT NULL PRIMARY KEY,
                "account_country_code" TEXT NOT NULL,
                "account_check_digits" TEXT NOT NULL,
                "account_bban" TEXT NOT NULL,
                "holder" UUID NOT NULL REFERENCES "holder"("id") ON UPDATE CASCADE ON DELETE CASCADE,
                "expiration" TEXT NOT NULL,
                "type" TEXT NOT NULL REFERENCES "card_type"("name") ON UPDATE CASCADE ON DELETE RESTRICT,
                FOREIGN KEY ("account_country_code", "account_check_digits", "account_bban")
                REFERENCES "account"("country_code", "check_digits", "bban")
                ON UPDATE CASCADE ON DELETE RESTRICT
            );
        </sql>
    </changeSet>
</databaseChangeLog>